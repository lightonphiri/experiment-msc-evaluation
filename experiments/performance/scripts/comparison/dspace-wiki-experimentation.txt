Instance set up
  -> A total of 15 seperate DSpace instances [1] were set up.


Collection Hierarchy
  -> 
  -> ./dspace structure-builder -f /home/phiri/Projects/masters/scripts/w1-structure.xml -o ../upload/w1-structure-out.xml -e lphiri@cs.uct.ac.za
  -> for workload in `seq 2 15`; do /usr/local/workloads/w$workload/bin/dspace structure-builder -f /home/phiri/Projects/masters/scripts/w$workload-structure.xml -o ../upload/w$workload-structure-out.xml -e lphiri@cs.uct.ac.za; done


SELECT h.handle, c.name 
FROM ((SELECT resource_id, handle FROM handle WHERE resource_type_id=3) as h JOIN 
(SELECT collection_id, name FROM collection) as c ON 
h.resource_id = c.collection_id);





for workload in range(1,16):
   dspacebenchmarks.dspacestructure('/home/phiri/Projects/masters/random/workload1/w'+str(workload), 'w'+str(workload), 'union-ndltd-org-ListSets.xml')



1. create database
createdb -U dspace -E UNICODE dspace -h localhost

for workload in `seq 1 15`; do createdb -U dspace -E UNICODE w$workload -h localhost; done

for workload in `seq 1 15`; do dropdb w$workload; done


for workload in `seq 1 15`
do
cp /home/phiri/Projects/masters/dspace/configs/w$workload-dspace.cfg /home/phiri/Projects/masters/dspace/dspace-3.1-release/dspace/target/dspace-3.1-build/config/dspace.cfg
cd /home/phiri/Projects/masters/dspace/dspace-3.1-release/dspace/target/dspace-3.1-build
ant fresh_install
done



2. create administrator
./dspace create-administrator

/usr/local/workloads/w1/bin/dspace create-administrator

3. create structure
sh /usr/local/dspace/bin/dspace structure-builder -f /home/phiri/Projects/masters/dspace/dspace-structure-w3.xml -o /usr/local/dspace/upload/dspace-structure-w3.xml.out -e lphiri@cs.uct.ac.za


for workload in `seq 1 15`
do 
sh /usr/local/workloads/w$workload/bin/dspace structure-builder -f /home/phiri/Projects/masters/dspace/"w"$workload-structure.xml -o /usr/local/workloads/w$workload/upload/"w"$workload-structure.xml.out -e lphiri@cs.uct.ac.za;
done


/usr/local/workloads/w11/bin/dspace structure-builder -f /home/phiri/Projects/masters/dspace/w11-structure.xml -o /usr/local/workloads/w11/upload/w11-structure.xml.out -e lphiri@cs.uct.ac.za


4. generate csv files using Python script

import dspacebenchmarks
dspacebenchmarks.dspacecsvfile('/home/phiri/Projects/masters/random/workload1/w5', 'dspace', 10, 'w5')
dspacebenchmarks.dspacecsvfile('/home/phiri/Projects/masters/random/workload1/w5', 'dspace', 100, 'w5')
dspacebenchmarks.dspacecsvfile('/home/phiri/Projects/masters/random/workload1/w5', 'dspace', 1000, 'w5')


import dspacebenchmarks
for workload in range(1,16):
   dspacebenchmarks.dspacecsvfile('/home/phiri/Projects/masters/random/workload1/w'+str(workload), 'w'+str(workload), 1000, 'w'+str(workload))


5. change configurations for bulk import
./config/modules/bulkedit.cfg


for workload in `seq 1 15`
do 
cp /home/phiri/Projects/masters/dspace/configs/bulkedit.cfg /usr/local/workloads/w$workload/config/modules/bulkedit.cfg
done


6. metadata-import utility

sh ../bin/dspace metadata-import -f dspace-bme-CHENGCHI.csv -e lphiri@cs.uct.ac.za -s


metadata-import -f $file -e lphiri@cs.uct.ac.za -s

for file in `ls /home/phiri/Projects/masters/dspace/ingestion/10/dspace-10* | grep dspace-10`; do sh /usr/local/dspace/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s; done


nohup sh -c 'for file in `ls /home/phiri/Projects/masters/dspace/ingestion/10/dspace-10* | grep dspace-10`; do sh /usr/local/dspace/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s; done' &

nohup sh -c 'for file in `ls /home/phiri/Projects/masters/dspace/ingestion/100/dspace-100* | grep dspace-100`; do sh /usr/local/dspace/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s; done' &


 #### Profiling #### 
nohup sh -c 'for file in `ls /home/phiri/Projects/masters/dspace/ingestion/1000/dspace-1000-* | grep dspace-1000-`; do echo "START: "$file; sh /usr/local/dspace/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s; echo "END: "$file; done' &



for workload in `seq 1 2`
do
echo "START: "$workload
for file in /home/phiri/Projects/masters/dspace/ingestion/workloads/w$workload/*-1000-*.csv 
do 
echo "START: "$file
#sh /usr/local/workloads/w$workload/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s
echo /usr/local/workloads/w$workload/bin/dspace metadata-import -f $file -e lphiri@cs.uct.ac.za -s
echo "END: "$file;
done
echo "END: "$workload
sleep 5
done



/usr/local/dspace/bin/dspace metadata-import -f /home/phiri/Projects/masters/dspace/dspace-1000-1.csv -e lphiri@cs.uct.ac.za -s




python -c "import dspacebenchmarks; dspacebenchmarks.dspacecsvfile('/home/phiri/Projects/masters/random/workload1/w8', 'w8', 10000)";


Log Analysis


cat dspace.log.2013-01-31 | grep item | awk '{sub(/,item_id/,"item_id"); print}' | awk '{sub(/,/,":"); print}' | awk '{print $1","$2","$3","$4","$5","$6}' > dspace-ingestion-log.csv



for workload in `seq 1 10`
do
echo "w$workload|"`cat /usr/local/workloads/w$workload/log/dspace.log.2013-02-02 | grep "Wrote Item" | head -n 1 | awk '{sub(/,/,"."); print}' | awk '{print $1"|"$2"|"$3""$4""$5""$6""$7""$8""$9""$10""$11}'`
echo "w$workload|"`cat /usr/local/workloads/w$workload/log/dspace.log.2013-02-02 | grep "Wrote Item" | tail -1 | awk '{sub(/,/,"."); print}' | awk '{print $1"|"$2"|"$3""$4""$5""$6""$7""$8""$9""$10""$11}'`
done


###### 


for workload in range(1, 11):
   dspacebenchmarks.dspaceingestlogoutput('/home/phiri/Sandbox/masters/dspace/' + 'w'+str(workload) + '-dspace.log.2013-02-02')



#### DSPACE PACKAGER  #####

create

su dspace
cd ~/benchmarks

for workload in `seq 1 12`
do
echo /usr/local/workloads/w$workload/bin/dspace packager -d -a -t AIP -e lphiri@cs.uct.ac.za -i 123456789/0 /home/dspace/benchmarks/aip/ingest/w1/w$workload/w$workload-aip.zip -u
done


restore
nohup sh /usr/local/workloads/w1b/bin/dspace packager -r -a -f -t AIP -e lphiri@cs.uct.ac.za -i 123456789/0 dspace/exports/w1/w1-aip.zip -u &
   
   
####### BACKUP


for workload in `seq 1 15`; do pg_dump w$workload | gzip > w$workload-db ; done
   



######## SINGLE ITEM INGEST

take note of item identifier in XML file
ingest item into DSpace
query postgresql (SELECT item_id FROM metadatavalue WHERE text_value LIKE '%oai:union.ndltd.org:MIT/oai:dspace.mit.edu:1721.1/15378%';) to get handle


SELECT DISTINCT h.handle, m.item_id 
FROM ((SELECT resource_id, handle FROM handle WHERE resource_type_id=2) as h JOIN 
(SELECT item_id FROM metadatavalue WHERE text_value LIKE '%oai:union.ndltd.org:MIT/oai:dspace.mit.edu:1721.1/15378%') as m ON 
h.resource_id = m.item_id);


Bash variable for handle id
item_id=$(psql w1 -t -c "SELECT DISTINCT m.item_id  FROM ((SELECT resource_id, handle FROM handle WHERE resource_type_id=2) as h JOIN  (SELECT item_id FROM metadatavalue WHERE text_value LIKE '%oai:union.ndltd.org:MIT/oai:dspace.mit.edu:1721.1/15378%') as m ON h.resource_id = m.item_id)")



####### DELETE ITEM 

*** ingest
/usr/local/dspace/bin/dspace metadata-import -f /home/phiri/Projects/masters/dspace/single-w3-1000-1.csv -e lphiri@cs.uct.ac.za -s

*** delete
  -> create map file (./ingest-single-item.sh dspace oai:union.ndltd.org:GEORGIA/oai:digitalarchive.gsu.edu:chemistry_diss-1010 > dspace-item-delete-mapfile.txt)
  -> run import utility command using mapfile
./ingest-single-item.sh dspace oai:union.ndltd.org:GEORGIA/oai:digitalarchive.gsu.edu:chemistry_diss-1010 > dspace-item-delete-mapfile.txt
./dspace import --delete --mapfile /home/phiri/Projects/masters/dspace/dspace-item-delete-mapfile.txt


*** get single ingest logs
for workload in `seq 1 12`; do cp /usr/local/workloads/w$workload/log/dspace.log.2013-02-04 w$workload-ingest-single-dspace.log.2013-02-04; done



###### OAI-PMH Configuration

 -> OAI manager to import items into OAI index
./dspace oai import




http://blabusch.cs.uct.ac.za:8080/w1/oai/request?verb=ListSets
http://blabusch.cs.uct.ac.za:8080/w1/oai/request?verb=ListRecords&metadataPrefix=oai_dc
http://blabusch.cs.uct.ac.za:8080/w1/oai/request?verb=ListIdentifiers&metadataPrefix=oai_dc
http://blabusch.cs.uct.ac.za:8080/w1/oai/request?verb=ListMetadataFormats


for workload in `seq 1 12`
do
echo "START WORKLOAD|w$workload|`date`"
# copy server.xml file
sudo cp /etc/tomcat6/w$workload-server.xml /etc/tomcat6/server.xml
###sudo cp /etc/tomcat6/xserver.xml /etc/tomcat6/server.xml
# restart tomcat
sudo invoke-rc.d tomcat6 restart
sleep 10
# import indicies
sh /usr/local/workloads/w$workload/bin/dspace oai import
##sh /usr/local/dspace/bin/dspace oai import
# script
sh /home/phiri/Projects/masters/scripts/oaipmh-dspace.sh w$workload
echo "END WORKLOAD|w$workload|`date`"
done


*** get results ***
cat nohup.out | grep -E "Document Path|(mean)|START|END" | grep -vE "Requests per second:|across all concurrent|median"

cat workloads-oai-performance-nohup.out | grep -E "Document Path|(mean)|START|END" | grep -vE "Requests per second:|across all concurrent|median"



















[1] https://wiki.duraspace.org/display/DSPACE/MultipleDspaceOneServer

